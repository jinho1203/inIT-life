<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      th:with="activePage='run'">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<div layout:fragment="content">
   <div class="config-wrapper" style="position: relative;">
          <div id="config" class="section-wrapper config-section">
        
<table style="width:100%; margin:0; padding:0;" border="0">
  <tbody>
    <tr>
      <td class="tdContent">
        <div id="divProjectPro">
          <h3 class="h3-project" style="font-size:24px;">í”„ë¡œì íŠ¸</h3>

          <!-- ì „ì²´ ë¼ì¸ì„ flexë¡œ ë¬¶ìŒ -->
          <div style="display: flex; align-items: center; justify-content: space-between;">
            
            <!-- ì¢Œì¸¡ ì…ë ¥ë€ë“¤ -->
            <div style="display: flex; align-items: center;">
              <span class="inputLabel">í”„ë¡œì íŠ¸ID</span>
              <input id="projectId" type="text" class="text" style="width:100px; margin-left:10px; text-align:center;" disabled>
              <input id="projectName" type="text" class="text" style="width:179px; margin-left:5px;" disabled>
              <button type="button" class="btn-darkgray" onclick="openPopup2()" style="margin-left:5px;">...</button>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </tbody>
</table>
      <!-- API ë¦¬ìŠ¤íŠ¸ -->
      <div style="margin-top: 20px;">
         <h3 class="h3-project" style="font-size:24px;">API ëª©ë¡</h3>
         <table>
             <thead>
                 <tr>
                    <th style="width:86px;">No.</th>
                  <th style="text-align:center;">API ì´ë¦„</th>
                  <th style="text-align:center;">ìš”ì²­ URL</th>
                  <th style="text-align:center;">ì‘ë‹µ í˜•ì‹</th>
                    </tr>
                </thead>
            <tbody id="sourceTableBody">
               <tr th:each="source : ${sourceList}" 
                   th:attr="data-sourceid=${source.sourceId}"
                   onclick="setSelectedSourceId(this)">    
                  <td th:text="'S'+${source.sourceId}"></td>
                  <td th:text="${source.sourceName}"></td>
                  <td th:text="${source.baseUrl}"></td>
                  <td style="text-align: center;">JSON</td>
               </tr>
            </tbody>
         </table>
         
   <!-- ìˆ¨ê²¨ì§„ sourceId -->
      <input type="hidden" name="sourceId" id="sourceId" />
   </div>

   <!-- ì…ë ¥/ì¶œë ¥ í•­ëª©ì„ ì¢Œìš°ë¡œ ë°°ì¹˜í•˜ëŠ” ë˜í¼ -->
   <div class="io-wrapper" style="display: flex; gap: 20px; margin-top: 30px;">
      <!-- ì…ë ¥ í•­ëª© -->
      <div style="flex: 1;">
          <h3 class="h3-project" style="font-size:24px;">ìš”ì²­ë³€ìˆ˜</h3>
          <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd;">
          <table style="width: 100%;">
              <thead>
                  <tr>
                      <th style="text-align:center;">í•­ëª©í‚¤</th>
                      <th style="text-align:center;">ê¸°ë³¸ê°’</th>
                      <th style="text-align:center;">ì„¤ëª…</th>
                      <th style="text-align:center;">í•„ìˆ˜ì—¬ë¶€ </th>
                  </tr>
              </thead>
               <tbody id="inputTableBody">
                     <tr th:each="input : ${inputList}" 
                         th:attr="data-inputid=${input.inputId}" 
                         onclick="setSelectedInputId(this)">
                      <td th:text="${input.inputKey}"></td>
                      <td class="ellipsis-cell" 
                     th:text="${input.inputValue}" 
                     title="[[${input.inputValue}]]"></td>
                      <td th:text="${input.inputExplain}"></td>
                      <td th:text="${input.reqParam}"></td>
                  </tr>
              </tbody>
          </table>
      </div>
           <button id="editBtn" type="button" onclick="toggleEdit(this)" 
                   class="btn btn-outline-warning" style="font-size: 15px; margin-top:10px">ìˆ˜ì •</button>
      </div>
   <!-- ì¶œë ¥ í•­ëª© -->
   <div style="flex: 1;">
       <h3 class="h3-project" style="font-size:24px;">ì¶œë ¥ ê²°ê³¼</h3>
        <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd;">
       <table border="1" style="width: 100%; border-collapse: collapse;">
           <thead>
               <tr>
                  <th style="text-align:center;">í•­ëª©í‚¤</th>
                   <th style="text-align:center;">ì„¤ëª…</th>
                   <th style="text-align:center;">ì¶œë ¥ì—¬ë¶€</th>
                   <th style="width: 40px;"></th>
               </tr>
           </thead>
          <tbody id="outputTableBody">
           <!--  ì…ë ¥ í•­ëª©ë„ ê°™ì´ ë³´ì´ê²Œ í•¨ -->
             <tr th:each="input : ${inputList}" 
                 th:attr="data-inputid=${input.inputId}" 
                 onclick="setSelectedInputId(this)">
                 <td th:text="${input.inputKey}"></td>
                 <td th:text="${input.inputValue}" 
                      style="display:none;" 
                      title="[[${input.inputValue}]]">
                  </td>
	              <td th:text="${input.inputExplain}"></td>
	              <td th:text="${input.reqParam}"></td>
	              <td style="text-align:center;">
			          <input type="checkbox" name="projectCheckbox" th:value="${output.outputId}">
			      </td>
	          </tr>
	         <!--  ì¶œë ¥ í•­ëª© í‘œì‹œ -->
	          <tr th:each="output : ${outputList}" 
	              th:attr="data-outputid=${output.outputId}" 
	              onclick="setSelectedOutputId(this)">
	              <td th:text="${output.outputKey}"></td>
	              <td th:text="${output.outputValue}" 
	                  style="display:none;" 
	                  title="[[${output.outputValue}]]"></td>
	              <td th:text="${output.outputExplain}"></td>
	              <td th:text="${output.reqParam}"></td>
	               <td style="text-align:center;">
			          <input type="checkbox" name="projectCheckbox" th:value="${output.outputId}">
			      </td>
	          </tr>
	        </tbody>
	    </table>
	    </div>
		</div>
</div>	
		<button type="button" onclick="openPopup5()" class="btn btn-outline-primary" style="font-size: 15px;margin-left: 1168px;margin-top: -3px;">ì‹¤í–‰ </button>
		<button type="button" onclick="goToApiStart()" class="btn btn-outline-primary" style="font-size: 15px;margin-left: 1231px;margin-top: -65px;">í…ŒìŠ¤íŠ¸</button>
		</div>
</div>

   <!-- popup2 (...ì‹¤í–‰ì‹œ í”„ë¡œì íŠ¸ ë¦¬ìŠ¤íŠ¸ ë‚˜ì˜¤ëŠ” ì„¤ì •ì¹¸ ) -->
   <div id="popup2">
     <div class="popup2-header">
       í”„ë¡œì íŠ¸ ì„ íƒ
       <span class="popup2-close" onclick="closePopup2()">Ã—</span>
     </div>
   
     <div class="popup2-body">
       <table id="projectTable" class="project-table">
         <thead>
           <tr>
             <th>í”„ë¡œì íŠ¸ID</th>
             <th>í”„ë¡œì íŠ¸ëª…</th>
           </tr>
         </thead>
         <tbody>
            <tr th:each="project : ${projectList}">
            <td th:text="'P'+${project.projectId}"></td>
            <td th:text="${project.projectName}"></td>
         </tr>
         </tbody>
       </table>
       <div class="popup2-buttons">
         <button type="button" class="btn btn-secondary" onclick="confirmSelection()">í™•ì¸</button>
         <button type="button" class="btn btn-outline-secondary" onclick="closePopup2()">ë‹«ê¸°</button>
       </div>
     </div>
   </div>

   <!-- popup5 (ì‹¤í–‰ì¹¸ ë°ì´í„°ê°€ ë‚˜ì˜¤ë„ë¡ í•´ì•¼í•¨) -->
	<div id="popup5">
	  <div class="popup2-header">
	    ë°ì´í„° í™•ì¸
	    <span class="popup2-close" onclick="closePopup5()">Ã—</span>
	  </div>
	  <div class="popup2-body">
	    <!-- í‘œ í‘œì‹œ ì˜ì—­ -->
	    <div id="apiDataPreview" style="max-height: 300px; overflow:auto;"></div>
	  </div>
	  <button class="btn btn-success" onclick="downloadExcel()" style="margin-bottom:20px; margin-left:20px;">Excel Download</button>
	</div>
</div>

<!-- pageScript í”„ë˜ê·¸ë¨¼íŠ¸ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì±„ìš°ê¸° -->
<th:block layout:fragment="pageScript">
<script>
//í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ
let selectedProject = null;

document.addEventListener("DOMContentLoaded", function () {
     const projectTable = document.getElementById("projectTable");
     const rows = projectTable.querySelectorAll("tbody tr");

     rows.forEach(row => {
       row.addEventListener("click", function () {
         // ê¸°ì¡´ ì„ íƒ ì œê±°
         rows.forEach(r => r.classList.remove("highlight"));
         // í˜„ì¬ ì„ íƒí•œ í–‰ì— í•˜ì´ë¼ì´íŠ¸
         this.classList.add("highlight");

         // âœ… ì—¬ê¸° ìˆ˜ì •í•¨
         const cells = this.getElementsByTagName("td");
         selectedProject = {
           projectId: parseInt(cells[0].innerText.trim().replace(/^P/, ''), 10),
           projectName: cells[1].innerText.trim()
         };
       });
     });
   });
   
function goToApiStart() {
    const projectId = document.getElementById("projectId").value;
    const projectName = document.getElementById("projectName").value;
   const sourceId = document.getElementById("sourceId").value;
    
    if (!projectId || !projectName) {
        Swal.fire({
            title: 'í”„ë¡œì íŠ¸ ì„ íƒ í•„ìš”',
            text: 'ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.',
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
        });
        return;
    }
    
    // ì„ íƒëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (openPopup5ì™€ ë™ì¼ ë¡œì§)
    const selectedData = {};
    document.querySelectorAll('#outputTableBody tr').forEach(tr => {
        const checkbox = tr.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const key = tr.dataset.key;
            const value = tr.querySelector('td:nth-child(2)').textContent.trim();
            if (key) selectedData[key] = value;
        }
    });    
    
    // ì„œë²„ì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/projectStart/getData?sourceId=${sourceId}`)
        .then(response => {
            if (!response.ok) throw new Error('API ë°ì´í„° í˜¸ì¶œ ì‹¤íŒ¨');
            return response.json();
        })
        .then(apiData => {
            // í‘œ ë³€í™˜ì„ ìœ„í•´ ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜
            let previewData;
            if (Array.isArray(apiData)) {
                previewData = apiData;
            } else if (Array.isArray(apiData.items)) {
                previewData = apiData.items;
            } else {
                previewData = [apiData];
            }

            // ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥
            sessionStorage.setItem("apiPreviewData", JSON.stringify(previewData));

            // /apistartë¡œ ì´ë™
            window.location.href = "/apistart";
        })
        .catch(err => {
            console.error(err);
            alert(err.message || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    
    // URL íŒŒë¼ë¯¸í„° ë¶™ì—¬ì„œ ì´ë™
   //location.href = `/apistart?projectId=${projectId}&projectName=${encodeURIComponent(projectName)}`;
}

function testConnection(button) {
    // ì—¬ê¸°ì— ì‹¤ì œ ì—°ê²° í…ŒìŠ¤íŠ¸ ë¡œì§ ë˜ëŠ” API í˜¸ì¶œì„ ë„£ì„ ìˆ˜ë„ ìˆìŒ
    const success = Math.random() > 0.5; // ì„ì‹œë¡œ ì„±ê³µ/ì‹¤íŒ¨ ë¬´ì‘ìœ„ ì²˜ë¦¬

    if (success) {
        alert("ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
        alert("ì—°ê²°ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
}
function openPopup2() {
    document.getElementById("popup2").style.display = "block";
  }

//íŒì—… ë‹«ê¸°
function closePopup2() {
  document.getElementById("popup2").style.display = "none";
  selectedProject = null;

  // ê°•ì¡° í•´ì œ
  document.querySelectorAll(".project-table tbody tr").forEach(row => {
    row.classList.remove("highlight");
  });
}
function openPopup5() {
	
    const sourceId = document.getElementById("sourceId").value;
    console.log("sourceId -> ", sourceId);

    if (!sourceId) {
        Swal.fire({
            title: 'API ì„ íƒ',
            text: 'APIë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.',
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
        });
        return;
    }

 // ì„ íƒëœ ë°ì´í„° ìˆ˜ì§‘ë¶€ (ë¬¸ì œì—†ìŒ)
	const selectedData = {};
	document.querySelectorAll('#outputTableBody tr').forEach(tr => {
	    const checkbox = tr.querySelector('input[type="checkbox"]');
	    if (checkbox && checkbox.checked) {
	        const key = tr.dataset.key;
	        const value = tr.querySelector('td:nth-child(2)').textContent.trim();
	        if (key) {
	            if (!selectedData[key]) selectedData[key] = [];
	            selectedData[key].push(value);
	        }
	    }
	});
    const payload = {
           sourceId: sourceId,
           selectedData: Object.keys(selectedData).length > 0 ? selectedData : null
       };
    
    console.log("ì„œë²„ë¡œ ë³´ë‚¼ ì„ íƒëœ ë°ì´í„°:", selectedData);

    // ì„œë²„ë¡œ ì „ì†¡ë¶€ (ìˆ˜ì •)
    fetch("/projectStart/customFullUrl", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            sourceId: sourceId,
            selectedData: selectedData
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('URL ì €ì¥ ì‹¤íŒ¨');
        return fetch(`/projectStart/getData?sourceId=${sourceId}`);
    })
    .then(response => {
        if (!response.ok) throw new Error('API ë°ì´í„° í˜¸ì¶œ ì‹¤íŒ¨');
        return response.json();
    })
	.then(apiData => {
	    let previewData;
	
	    if (Array.isArray(apiData)) {
	        previewData = apiData;
	    } else if (Array.isArray(apiData.items)) {
	        previewData = apiData.items;
	    } else {
	        previewData = [apiData];
	    }
	
	    console.log("previewData ìµœì¢… ê°’:", previewData);
	    // í‘œ ìƒì„±
	    if (previewData.length > 0) {
	        const headers = Object.keys(previewData[0]); // ì²« ë²ˆì§¸ ê°ì²´ì˜ keyë“¤ì„ í—¤ë”ë¡œ ì‚¬ìš©
	        let tableHtml = "<table border='1' style='border-collapse:collapse; width:100%'><thead><tr>";
	        headers.forEach(h => {
	            tableHtml += `<th style="padding:4px; background:#f0f0f0;">${h}</th>`;
	        });
	        tableHtml += "</tr></thead><tbody>";
	
	        previewData.forEach(row => {
	            tableHtml += "<tr>";
	            headers.forEach(h => {
	                tableHtml += `<td style="padding:4px;">${row[h] !== undefined ? row[h] : ''}</td>`;
	            });
	            tableHtml += "</tr>";
	        });
	
	        tableHtml += "</tbody></table>";
	        document.getElementById("apiDataPreview").innerHTML = tableHtml;
	    } else {
	        document.getElementById("apiDataPreview").innerHTML = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
	    }
	
	    document.getElementById("popup5").style.display = "block";
	})
}
   
function closePopup5() {
    document.getElementById("popup5").style.display = "none";
   }

function downloadExcel(){
	const table = document.querySelector("#apiDataPreview table");
	
    // HTML Table â†’ SheetJS ì›Œí¬ì‹œíŠ¸ë¡œ ë³€í™˜
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);

    // ì›Œí¬ë¶ì— ì‹œíŠ¸ ì¶”ê°€
    XLSX.utils.book_append_sheet(wb, ws, "API ë°ì´í„°");

    // ì—‘ì…€ íŒŒì¼ ì €ì¥
    XLSX.writeFile(wb, "api_data.xlsx");	
}

function apiResult(){
   const sourceId = document.getElementById("sourceId").value;
   
    if (!sourceId) {
        Swal.fire({
            title: 'API ì„ íƒ',
            text: 'APIë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.',
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
        });
        return;
    }
    
    // ì„ íƒëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (openPopup5ì™€ ë™ì¼)
    const selectedData = {};
    document.querySelectorAll('#outputTableBody tr').forEach(tr => {
        const checkbox = tr.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const key = tr.dataset.key;
            const value = tr.querySelector('td:nth-child(2)').textContent.trim();
            if (key) selectedData[key] = value;
        }
    });
    
    // ì„œë²„ì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/projectStart/getData?sourceId=${sourceId}`)
        .then(response => {
            if (!response.ok) throw new Error('API ë°ì´í„° í˜¸ì¶œ ì‹¤íŒ¨');
            return response.json();
        })
        .then(apiData => {
            // í‘œ ë³€í™˜ì„ ìœ„í•´ ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜
            let previewData;
            if (Array.isArray(apiData)) {
                previewData = apiData;
            } else if (Array.isArray(apiData.items)) {
                previewData = apiData.items;
            } else {
                previewData = [apiData];
            }

            // ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥
            sessionStorage.setItem("apiPreviewData", JSON.stringify(previewData));

            // /apistartë¡œ ì´ë™
            window.location.href = "/apistart";
        })
        .catch(err => {
            console.error(err);
            alert(err.message || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
}

// í”„ë¡œì íŠ¸ ì˜ì—­ì—ì„œ ... ë²„íŠ¼ í´ë¦­ ì‹œ
function confirmSelection() {
   console.log('ì„ íƒëœ í”„ë¡œì íŠ¸:', selectedProject);
     if (selectedProject) {
          Swal.fire({
            title: 'í”„ë¡œì íŠ¸ ì„ íƒ ì™„ë£Œ',
            text: 'í”„ë¡œì íŠ¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
            icon: 'success',
            confirmButtonText: 'í™•ì¸'
          }).then(() => {
            document.getElementById("projectId").value = selectedProject.projectId;
            document.getElementById("projectName").value = selectedProject.projectName;

            // âœ… ì„ íƒëœ í”„ë¡œì íŠ¸ì— ë§ëŠ” sourceList API í˜¸ì¶œ
            fetch(`/projectStart/getSourceList?projectId=${selectedProject.projectId}`)
              .then(response => response.json())
              .then(data => {
                const tbody = document.getElementById("sourceTableBody");
                tbody.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

                data.forEach((source, index) => {
                  const row = document.createElement('tr');
                  row.setAttribute("data-sourceid", source.sourceId);
                  row.setAttribute("onclick", "setSelectedSourceId(this)");

                  row.innerHTML = `
                    <td>S${source.sourceId}</td>
                    <td>${source.sourceName}</td>
                    <td>${source.baseUrl}</td>
                    <td style="text-align: center;">JSON</td>
                  `;
                  tbody.appendChild(row);
                });
              })
              .catch(error => console.error('API ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error));

            closePopup2(); // íŒì—… ë‹«ê¸°
          });
        } else {
          Swal.fire({
            title: 'ì„ íƒëœ í•­ëª© ì—†ìŒ',
            text: 'ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.',
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
          });
        }
      }
function setSelectedSourceId(row) {
    console.log("setSelectedSourceId í˜¸ì¶œë¨");
    
    const projectId = document.getElementById("projectId").value;
    const projectName  = document.getElementById("projectName").value;
   
    console.log("í”„ë¡œì íŠ¸ID:", projectId);
    console.log("í”„ë¡œì íŠ¸ëª…:", projectName);
    
    selectedSourceId = row.getAttribute("data-sourceid");
    console.log("ì„ íƒëœ ID:", selectedSourceId);

    const hiddenInput = document.getElementById("sourceId");
    if (hiddenInput) {
        hiddenInput.value = selectedSourceId;
        console.log("hidden inputì— ê°’ ì„¸íŒ…:", hiddenInput.value);
    }

    document.querySelectorAll("#sourceTableBody tr").forEach(r => r.classList.remove("highlight"));
    row.classList.add("highlight");
   
    fetch(`/projectStart/IOList?sourceId=${selectedSourceId}`)
    .then(response => response.json())
    .then(data => {
         const inputTbody = document.getElementById("inputTableBody");
         inputTbody.innerHTML = ""; // ì´ˆê¸°í™”    

            data.inputList.forEach(input => {
                const tr = document.createElement("tr");
                tr.setAttribute("data-inputid", input.inputId);
                tr.innerHTML = `
                    <td>${input.inputKey}</td>
                    <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                        title="${input.inputValue}"
                        data-hidden-value="${input.inputValue}">
                        ${input.inputValue}
                    </td>
                    <td>${input.inputExplain}</td>
                    <td style="text-align: center;">${input.reqParam === 'Y' ? 'í•„ìˆ˜' : 'ì„ íƒ'}</td>
                `;
                inputTbody.appendChild(tr);
            });

            // ì¶œë ¥ í•­ëª© tbody
            const outputTbody = document.getElementById("outputTableBody");
            outputTbody.innerHTML = ""; // ì´ˆê¸°í™”
            
            // 1) ì…ë ¥ ë¦¬ìŠ¤íŠ¸ 
            data.inputList.forEach(input => {
                const tr = document.createElement("tr");
                
                tr.setAttribute("data-key", input.inputKey);
                tr.setAttribute("data-inputid", input.inputId);
                
                tr.innerHTML = `
                    <td>${input.inputKey}</td>
                    <td style="display:none">${input.inputValue}</td>
                    <td>${input.inputExplain}</td>
                    <td style="text-align:center;">${input.reqParam === 'Y' ? 'í•„ìˆ˜' : 'ì„ íƒ'}</td>
                    <td style="text-align:center;">
                    <input type="checkbox" name="" value="${input.inputId}" ${input.reqParam === 'Y' ? 'checked' : ''}>
                    </td>
                    
                `;
                outputTbody.appendChild(tr);
            });

            // 2) ì¶œë ¥ ë¦¬ìŠ¤íŠ¸ 
            data.outputList.forEach(output => {
                const tr = document.createElement("tr");
                tr.setAttribute("data-outputid", output.outputId);
                tr.setAttribute("data-key", output.outputKey); // âœ… ì—¬ê¸° ì¶”ê°€
                tr.onclick = function() { setSelectedOutputId(this); };
                tr.innerHTML = `
                    <td>${output.outputKey}</td>
                    <td style="display:none">${output.outputValue}</td>
                    <td>${output.outputExplain}</td>
                    <td style="text-align: center;">${output.reqParam === 'Y' ? 'í•„ìˆ˜' : 'ì„ íƒ'}</td>
                    <td style="text-align:center;">
                    <input type="checkbox" name="" value="${output.outputId}" ${output.reqParam === 'Y' ? 'checked' : ''}>
                    </td>
                `;
                outputTbody.appendChild(tr);
            });
        }) 
        .catch(err => {
            console.error('ì…ì¶œë ¥ í•­ëª© ë¡œë”© ì‹¤íŒ¨:', err);
            alert("ì…ë ¥/ì¶œë ¥ í•­ëª© ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
}

function fetchProjectDetails(projectId) {
    fetch(`/projectStart/projectDetails?projectId=${projectId}`)
       .then(res => res.json())
       .then(data => {
         if (data) {
           populateApiTable(data.apiList || []);
           populateInputTable(data.inputList || []);
           populateOutputTable(data.outputList || []);
         }
       })
       .catch(err => {
         console.error('í”„ë¡œì íŠ¸ ì„¸ë¶€ì •ë³´ ë¡œë”© ì˜¤ë¥˜:', err);
         Swal.fire('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
       });
   }
function populateApiTable(apiList) {
     const tbody = document.querySelector("#apiTableBody"); // tbodyì— id ë¶€ì—¬ í•„ìš”
     tbody.innerHTML = "";

     apiList.forEach((api, index) => {
       const row = `
         <tr>
           <td style="text-align:center;">${index + 1}</td>
           <td style="text-align:center;">${api.sourceName}</td>
           <td style="text-align:center;">${api.baseUrl}</td>
           <td style="text-align:center;">${api.responseFormat}</td>
         </tr>
       `;
       tbody.insertAdjacentHTML("beforeend", row);
     });
   }

function populateInputTable(inputList) {
  const tbody = document.querySelector("#inputTableBody");
  tbody.innerHTML = "";

  inputList.forEach(input => {
    const row = `
      <tr>
        <td style="text-align:center;">${input.defaultValue}</td>
        <td style="text-align:center;">${input.description}</td>
        <td style="text-align:center;">${input.type}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

function populateOutputTable(outputList) {
  const tbody = document.querySelector("#outputTableBody");
  tbody.innerHTML = "";

  outputList.forEach(output => {
    const row = `
      <tr>
        <td style="text-align:center;">${output.defaultValue}</td>
        <td style="text-align:center;">${output.description}</td>
        <td style="text-align:center;">${output.type}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}
window.addEventListener('DOMContentLoaded', () => {
    const path = window.location.pathname;

    const configBtn = document.getElementById("btn-config");
    const startBtn = document.getElementById("btn-start");

    if (configBtn && startBtn) {
       if (path.includes("projectConfig")) {
         configBtn.className = "btn-run";
         startBtn.className = "btn-config";
       } else if (path.includes("projectStart")) {
         configBtn.className = "btn-config";
         startBtn.className = "btn-run";
       } else {
         configBtn.className = "btn-config";
         startBtn.className = "btn-config";
       }
    }
  });
  
//ìˆ˜ì • ë¼ì¸   
function toggleEdit(button) {
    const inputTbody = document.getElementById("inputTableBody");
    if (!inputTbody) {
        console.error("inputTableBodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    if (button.textContent === "ìˆ˜ì •") {
        button.textContent = "í™•ì¸";
        button.classList.remove("btn-outline-warning");
        button.classList.add("btn-outline-success");

        // td -> input
        inputTbody.querySelectorAll("tr").forEach(tr => {
            const td = tr.children[1]; // ê¸°ë³¸ê°’ td
            const value = td.textContent.trim();
            td.innerHTML = `<input type="text" style="width:100%;" value="${value}">`;
        });

    } else {
        button.textContent = "ìˆ˜ì •";
        button.classList.remove("btn-outline-success");
        button.classList.add("btn-outline-warning");

        // âœ… 1. ì„œë²„ë¡œ ë³´ë‚¼ ë°°ì—´ ì„ ì–¸
        const updatedInputs = [];

        // âœ… 2. input ê°’ì„ ìˆ˜ì§‘í•˜ê³  í™”ë©´ì— ë°˜ì˜
        inputTbody.querySelectorAll("tr").forEach(tr => {
            const td = tr.children[1];
            const input = td.querySelector("input");
            if (input) {
                td.textContent = input.value; // í™”ë©´ì— ë°˜ì˜
                updatedInputs.push({
                    inputId: tr.getAttribute("data-inputid"),
                    inputValue: input.value
                });
            }
        });

        // âœ… 3. ì„œë²„ë¡œ ì „ì†¡
        fetch('/projectStart/updateInputValues', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedInputs)
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    // ğŸ”¹ í˜„ì¬ ì„ íƒëœ row ë‹¤ì‹œ ë¡œë“œí•´ì„œ ìµœì‹  ë°ì´í„° ë°˜ì˜
                    const selectedRow = document.querySelector("#sourceTableBody tr.highlight");
                    if (selectedRow) {
                        setSelectedSourceId(selectedRow);
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨',
                    text: 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                });
            }
        })
        .catch(err => {
            console.error("ì„œë²„ í†µì‹  ì‹¤íŒ¨:", err);
            Swal.fire({
                icon: 'error',
                title: 'ì„œë²„ í†µì‹  ì‹¤íŒ¨',
                text: 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
            });
        });
    }
}
</script>
</body>
</html>