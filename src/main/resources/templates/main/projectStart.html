<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      th:with="activePage='run'">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<div layout:fragment="content">
   <div class="config-wrapper" style="position: relative;">
          <div id="config" class="section-wrapper config-section">
        
<table style="width:100%; margin:0; padding:0;" border="0">
  <tbody>
    <tr>
      <td class="tdContent">
        <div id="divProjectPro">
          <h3 class="h3-project" style="font-size:24px;">프로젝트</h3>

          <!-- 전체 라인을 flex로 묶음 -->
          <div style="display: flex; align-items: center; justify-content: space-between;">
            
            <!-- 좌측 입력란들 -->
            <div style="display: flex; align-items: center;">
              <span class="inputLabel">프로젝트ID</span>
              <input id="projectId" type="text" class="text" style="width:100px; margin-left:10px; text-align:center;" disabled>
              <input id="projectName" type="text" class="text" style="width:179px; margin-left:5px;" disabled>
              <button type="button" class="btn-darkgray" onclick="openPopup2()" style="margin-left:5px;">...</button>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </tbody>
</table>
      <!-- API 리스트 -->
      <div style="margin-top: 20px;">
         <h3 class="h3-project" style="font-size:24px;">API 목록</h3>
         <table>
             <thead>
                 <tr>
                    <th style="width:86px;">No.</th>
                  <th style="text-align:center;">API 이름</th>
                  <th style="text-align:center;">요청 URL</th>
                  <th style="text-align:center;">응답 형식</th>
                    </tr>
                </thead>
            <tbody id="sourceTableBody">
               <tr th:each="source : ${sourceList}" 
                   th:attr="data-sourceid=${source.sourceId}"
                   onclick="setSelectedSourceId(this)">    
                  <td th:text="'S'+${source.sourceId}"></td>
                  <td th:text="${source.sourceName}"></td>
                  <td th:text="${source.baseUrl}"></td>
                  <td style="text-align: center;">JSON</td>
               </tr>
            </tbody>
         </table>
         
   <!-- 숨겨진 sourceId -->
      <input type="hidden" name="sourceId" id="sourceId" />
   </div>

   <!-- 입력/출력 항목을 좌우로 배치하는 래퍼 -->
   <div class="io-wrapper" style="display: flex; gap: 20px; margin-top: 30px;">
      <!-- 입력 항목 -->
      <div style="flex: 1;">
          <h3 class="h3-project" style="font-size:24px;">요청변수</h3>
          <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd;">
          <table style="width: 100%;">
              <thead>
                  <tr>
                      <th style="text-align:center;">항목키</th>
                      <th style="text-align:center;">기본값</th>
                      <th style="text-align:center;">설명</th>
                      <th style="text-align:center;">필수여부 </th>
                  </tr>
              </thead>
               <tbody id="inputTableBody">
                     <tr th:each="input : ${inputList}" 
                         th:attr="data-inputid=${input.inputId}" 
                         onclick="setSelectedInputId(this)">
                      <td th:text="${input.inputKey}"></td>
                      <td class="ellipsis-cell" 
                     th:text="${input.inputValue}" 
                     title="[[${input.inputValue}]]"></td>
                      <td th:text="${input.inputExplain}"></td>
                      <td th:text="${input.reqParam}"></td>
                  </tr>
              </tbody>
          </table>
      </div>
           <button id="editBtn" type="button" onclick="toggleEdit(this)" 
                   class="btn btn-outline-warning" style="font-size: 15px; margin-top:10px">수정</button>
      </div>
   <!-- 출력 항목 -->
   <div style="flex: 1;">
       <h3 class="h3-project" style="font-size:24px;">출력 결과</h3>
        <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd;">
       <table border="1" style="width: 100%; border-collapse: collapse;">
           <thead>
               <tr>
                  <th style="text-align:center;">항목키</th>
                   <th style="text-align:center;">설명</th>
                   <th style="text-align:center;">출력여부</th>
                   <th style="width: 40px;"></th>
               </tr>
           </thead>
          <tbody id="outputTableBody">
           <!--  입력 항목도 같이 보이게 함 -->
             <tr th:each="input : ${inputList}" 
                 th:attr="data-inputid=${input.inputId}" 
                 onclick="setSelectedInputId(this)">
                 <td th:text="${input.inputKey}"></td>
                 <td th:text="${input.inputValue}" 
                      style="display:none;" 
                      title="[[${input.inputValue}]]">
                  </td>
	              <td th:text="${input.inputExplain}"></td>
	              <td th:text="${input.reqParam}"></td>
	              <td style="text-align:center;">
			          <input type="checkbox" name="projectCheckbox" th:value="${output.outputId}">
			      </td>
	          </tr>
	         <!--  출력 항목 표시 -->
	          <tr th:each="output : ${outputList}" 
	              th:attr="data-outputid=${output.outputId}" 
	              onclick="setSelectedOutputId(this)">
	              <td th:text="${output.outputKey}"></td>
	              <td th:text="${output.outputValue}" 
	                  style="display:none;" 
	                  title="[[${output.outputValue}]]"></td>
	              <td th:text="${output.outputExplain}"></td>
	              <td th:text="${output.reqParam}"></td>
	               <td style="text-align:center;">
			          <input type="checkbox" name="projectCheckbox" th:value="${output.outputId}">
			      </td>
	          </tr>
	        </tbody>
	    </table>
	    </div>
		</div>
</div>	
		<button type="button" onclick="openPopup5()" class="btn btn-outline-primary" style="font-size: 15px;margin-left: 1168px;margin-top: -3px;">실행 </button>
		<button type="button" onclick="goToApiStart()" class="btn btn-outline-primary" style="font-size: 15px;margin-left: 1231px;margin-top: -65px;">테스트</button>
		</div>
</div>

   <!-- popup2 (...실행시 프로젝트 리스트 나오는 설정칸 ) -->
   <div id="popup2">
     <div class="popup2-header">
       프로젝트 선택
       <span class="popup2-close" onclick="closePopup2()">×</span>
     </div>
   
     <div class="popup2-body">
       <table id="projectTable" class="project-table">
         <thead>
           <tr>
             <th>프로젝트ID</th>
             <th>프로젝트명</th>
           </tr>
         </thead>
         <tbody>
            <tr th:each="project : ${projectList}">
            <td th:text="'P'+${project.projectId}"></td>
            <td th:text="${project.projectName}"></td>
         </tr>
         </tbody>
       </table>
       <div class="popup2-buttons">
         <button type="button" class="btn btn-secondary" onclick="confirmSelection()">확인</button>
         <button type="button" class="btn btn-outline-secondary" onclick="closePopup2()">닫기</button>
       </div>
     </div>
   </div>

   <!-- popup5 (실행칸 데이터가 나오도록 해야함) -->
	<div id="popup5">
	  <div class="popup2-header">
	    데이터 확인
	    <span class="popup2-close" onclick="closePopup5()">×</span>
	  </div>
	  <div class="popup2-body">
	    <!-- 표 표시 영역 -->
	    <div id="apiDataPreview" style="max-height: 300px; overflow:auto;"></div>
	  </div>
	  <button class="btn btn-success" onclick="downloadExcel()" style="margin-bottom:20px; margin-left:20px;">Excel Download</button>
	</div>
</div>

<!-- pageScript 프래그먼트로 스크립트 채우기 -->
<th:block layout:fragment="pageScript">
<script>
//테이블 행 클릭 시
let selectedProject = null;

document.addEventListener("DOMContentLoaded", function () {
     const projectTable = document.getElementById("projectTable");
     const rows = projectTable.querySelectorAll("tbody tr");

     rows.forEach(row => {
       row.addEventListener("click", function () {
         // 기존 선택 제거
         rows.forEach(r => r.classList.remove("highlight"));
         // 현재 선택한 행에 하이라이트
         this.classList.add("highlight");

         // ✅ 여기 수정함
         const cells = this.getElementsByTagName("td");
         selectedProject = {
           projectId: parseInt(cells[0].innerText.trim().replace(/^P/, ''), 10),
           projectName: cells[1].innerText.trim()
         };
       });
     });
   });
   
function goToApiStart() {
    const projectId = document.getElementById("projectId").value;
    const projectName = document.getElementById("projectName").value;
   const sourceId = document.getElementById("sourceId").value;
    
    if (!projectId || !projectName) {
        Swal.fire({
            title: '프로젝트 선택 필요',
            text: '먼저 프로젝트를 선택해주세요.',
            icon: 'warning',
            confirmButtonText: '확인'
        });
        return;
    }
    
    // 선택된 데이터 가져오기 (openPopup5와 동일 로직)
    const selectedData = {};
    document.querySelectorAll('#outputTableBody tr').forEach(tr => {
        const checkbox = tr.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const key = tr.dataset.key;
            const value = tr.querySelector('td:nth-child(2)').textContent.trim();
            if (key) selectedData[key] = value;
        }
    });    
    
    // 서버에서 실제 데이터 가져오기
    fetch(`/projectStart/getData?sourceId=${sourceId}`)
        .then(response => {
            if (!response.ok) throw new Error('API 데이터 호출 실패');
            return response.json();
        })
        .then(apiData => {
            // 표 변환을 위해 배열 형태로 변환
            let previewData;
            if (Array.isArray(apiData)) {
                previewData = apiData;
            } else if (Array.isArray(apiData.items)) {
                previewData = apiData.items;
            } else {
                previewData = [apiData];
            }

            // 브라우저에 임시 저장
            sessionStorage.setItem("apiPreviewData", JSON.stringify(previewData));

            // /apistart로 이동
            window.location.href = "/apistart";
        })
        .catch(err => {
            console.error(err);
            alert(err.message || "오류가 발생했습니다.");
        });
    
    // URL 파라미터 붙여서 이동
   //location.href = `/apistart?projectId=${projectId}&projectName=${encodeURIComponent(projectName)}`;
}

function testConnection(button) {
    // 여기에 실제 연결 테스트 로직 또는 API 호출을 넣을 수도 있음
    const success = Math.random() > 0.5; // 임시로 성공/실패 무작위 처리

    if (success) {
        alert("연결되었습니다.");
    } else {
        alert("연결에 실패하였습니다.");
    }
}
function openPopup2() {
    document.getElementById("popup2").style.display = "block";
  }

//팝업 닫기
function closePopup2() {
  document.getElementById("popup2").style.display = "none";
  selectedProject = null;

  // 강조 해제
  document.querySelectorAll(".project-table tbody tr").forEach(row => {
    row.classList.remove("highlight");
  });
}
function openPopup5() {
	
    const sourceId = document.getElementById("sourceId").value;
    console.log("sourceId -> ", sourceId);

    if (!sourceId) {
        Swal.fire({
            title: 'API 선택',
            text: 'API를 먼저 선택해주세요.',
            icon: 'warning',
            confirmButtonText: '확인'
        });
        return;
    }

 // 선택된 데이터 수집부 (문제없음)
	const selectedData = {};
	document.querySelectorAll('#outputTableBody tr').forEach(tr => {
	    const checkbox = tr.querySelector('input[type="checkbox"]');
	    if (checkbox && checkbox.checked) {
	        const key = tr.dataset.key;
	        const value = tr.querySelector('td:nth-child(2)').textContent.trim();
	        if (key) {
	            if (!selectedData[key]) selectedData[key] = [];
	            selectedData[key].push(value);
	        }
	    }
	});
    const payload = {
           sourceId: sourceId,
           selectedData: Object.keys(selectedData).length > 0 ? selectedData : null
       };
    
    console.log("서버로 보낼 선택된 데이터:", selectedData);

    // 서버로 전송부 (수정)
    fetch("/projectStart/customFullUrl", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            sourceId: sourceId,
            selectedData: selectedData
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('URL 저장 실패');
        return fetch(`/projectStart/getData?sourceId=${sourceId}`);
    })
    .then(response => {
        if (!response.ok) throw new Error('API 데이터 호출 실패');
        return response.json();
    })
	.then(apiData => {
	    let previewData;
	
	    if (Array.isArray(apiData)) {
	        previewData = apiData;
	    } else if (Array.isArray(apiData.items)) {
	        previewData = apiData.items;
	    } else {
	        previewData = [apiData];
	    }
	
	    console.log("previewData 최종 값:", previewData);
	    // 표 생성
	    if (previewData.length > 0) {
	        const headers = Object.keys(previewData[0]); // 첫 번째 객체의 key들을 헤더로 사용
	        let tableHtml = "<table border='1' style='border-collapse:collapse; width:100%'><thead><tr>";
	        headers.forEach(h => {
	            tableHtml += `<th style="padding:4px; background:#f0f0f0;">${h}</th>`;
	        });
	        tableHtml += "</tr></thead><tbody>";
	
	        previewData.forEach(row => {
	            tableHtml += "<tr>";
	            headers.forEach(h => {
	                tableHtml += `<td style="padding:4px;">${row[h] !== undefined ? row[h] : ''}</td>`;
	            });
	            tableHtml += "</tr>";
	        });
	
	        tableHtml += "</tbody></table>";
	        document.getElementById("apiDataPreview").innerHTML = tableHtml;
	    } else {
	        document.getElementById("apiDataPreview").innerHTML = "데이터가 없습니다.";
	    }
	
	    document.getElementById("popup5").style.display = "block";
	})
}
   
function closePopup5() {
    document.getElementById("popup5").style.display = "none";
   }

function downloadExcel(){
	const table = document.querySelector("#apiDataPreview table");
	
    // HTML Table → SheetJS 워크시트로 변환
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);

    // 워크북에 시트 추가
    XLSX.utils.book_append_sheet(wb, ws, "API 데이터");

    // 엑셀 파일 저장
    XLSX.writeFile(wb, "api_data.xlsx");	
}

function apiResult(){
   const sourceId = document.getElementById("sourceId").value;
   
    if (!sourceId) {
        Swal.fire({
            title: 'API 선택',
            text: 'API를 먼저 선택해주세요.',
            icon: 'warning',
            confirmButtonText: '확인'
        });
        return;
    }
    
    // 선택된 데이터 가져오기 (openPopup5와 동일)
    const selectedData = {};
    document.querySelectorAll('#outputTableBody tr').forEach(tr => {
        const checkbox = tr.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const key = tr.dataset.key;
            const value = tr.querySelector('td:nth-child(2)').textContent.trim();
            if (key) selectedData[key] = value;
        }
    });
    
    // 서버에서 실제 데이터 가져오기
    fetch(`/projectStart/getData?sourceId=${sourceId}`)
        .then(response => {
            if (!response.ok) throw new Error('API 데이터 호출 실패');
            return response.json();
        })
        .then(apiData => {
            // 표 변환을 위해 배열 형태로 변환
            let previewData;
            if (Array.isArray(apiData)) {
                previewData = apiData;
            } else if (Array.isArray(apiData.items)) {
                previewData = apiData.items;
            } else {
                previewData = [apiData];
            }

            // 브라우저에 임시 저장
            sessionStorage.setItem("apiPreviewData", JSON.stringify(previewData));

            // /apistart로 이동
            window.location.href = "/apistart";
        })
        .catch(err => {
            console.error(err);
            alert(err.message || "오류가 발생했습니다.");
        });
}

// 프로젝트 영역에서 ... 버튼 클릭 시
function confirmSelection() {
   console.log('선택된 프로젝트:', selectedProject);
     if (selectedProject) {
          Swal.fire({
            title: '프로젝트 선택 완료',
            text: '프로젝트가 설정되었습니다.',
            icon: 'success',
            confirmButtonText: '확인'
          }).then(() => {
            document.getElementById("projectId").value = selectedProject.projectId;
            document.getElementById("projectName").value = selectedProject.projectName;

            // ✅ 선택된 프로젝트에 맞는 sourceList API 호출
            fetch(`/projectStart/getSourceList?projectId=${selectedProject.projectId}`)
              .then(response => response.json())
              .then(data => {
                const tbody = document.getElementById("sourceTableBody");
                tbody.innerHTML = ''; // 기존 목록 초기화

                data.forEach((source, index) => {
                  const row = document.createElement('tr');
                  row.setAttribute("data-sourceid", source.sourceId);
                  row.setAttribute("onclick", "setSelectedSourceId(this)");

                  row.innerHTML = `
                    <td>S${source.sourceId}</td>
                    <td>${source.sourceName}</td>
                    <td>${source.baseUrl}</td>
                    <td style="text-align: center;">JSON</td>
                  `;
                  tbody.appendChild(row);
                });
              })
              .catch(error => console.error('API 목록 로딩 실패:', error));

            closePopup2(); // 팝업 닫기
          });
        } else {
          Swal.fire({
            title: '선택된 항목 없음',
            text: '먼저 프로젝트를 선택해주세요.',
            icon: 'warning',
            confirmButtonText: '확인'
          });
        }
      }
function setSelectedSourceId(row) {
    console.log("setSelectedSourceId 호출됨");
    
    const projectId = document.getElementById("projectId").value;
    const projectName  = document.getElementById("projectName").value;
   
    console.log("프로젝트ID:", projectId);
    console.log("프로젝트명:", projectName);
    
    selectedSourceId = row.getAttribute("data-sourceid");
    console.log("선택된 ID:", selectedSourceId);

    const hiddenInput = document.getElementById("sourceId");
    if (hiddenInput) {
        hiddenInput.value = selectedSourceId;
        console.log("hidden input에 값 세팅:", hiddenInput.value);
    }

    document.querySelectorAll("#sourceTableBody tr").forEach(r => r.classList.remove("highlight"));
    row.classList.add("highlight");
   
    fetch(`/projectStart/IOList?sourceId=${selectedSourceId}`)
    .then(response => response.json())
    .then(data => {
         const inputTbody = document.getElementById("inputTableBody");
         inputTbody.innerHTML = ""; // 초기화    

            data.inputList.forEach(input => {
                const tr = document.createElement("tr");
                tr.setAttribute("data-inputid", input.inputId);
                tr.innerHTML = `
                    <td>${input.inputKey}</td>
                    <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                        title="${input.inputValue}"
                        data-hidden-value="${input.inputValue}">
                        ${input.inputValue}
                    </td>
                    <td>${input.inputExplain}</td>
                    <td style="text-align: center;">${input.reqParam === 'Y' ? '필수' : '선택'}</td>
                `;
                inputTbody.appendChild(tr);
            });

            // 출력 항목 tbody
            const outputTbody = document.getElementById("outputTableBody");
            outputTbody.innerHTML = ""; // 초기화
            
            // 1) 입력 리스트 
            data.inputList.forEach(input => {
                const tr = document.createElement("tr");
                
                tr.setAttribute("data-key", input.inputKey);
                tr.setAttribute("data-inputid", input.inputId);
                
                tr.innerHTML = `
                    <td>${input.inputKey}</td>
                    <td style="display:none">${input.inputValue}</td>
                    <td>${input.inputExplain}</td>
                    <td style="text-align:center;">${input.reqParam === 'Y' ? '필수' : '선택'}</td>
                    <td style="text-align:center;">
                    <input type="checkbox" name="" value="${input.inputId}" ${input.reqParam === 'Y' ? 'checked' : ''}>
                    </td>
                    
                `;
                outputTbody.appendChild(tr);
            });

            // 2) 출력 리스트 
            data.outputList.forEach(output => {
                const tr = document.createElement("tr");
                tr.setAttribute("data-outputid", output.outputId);
                tr.setAttribute("data-key", output.outputKey); // ✅ 여기 추가
                tr.onclick = function() { setSelectedOutputId(this); };
                tr.innerHTML = `
                    <td>${output.outputKey}</td>
                    <td style="display:none">${output.outputValue}</td>
                    <td>${output.outputExplain}</td>
                    <td style="text-align: center;">${output.reqParam === 'Y' ? '필수' : '선택'}</td>
                    <td style="text-align:center;">
                    <input type="checkbox" name="" value="${output.outputId}" ${output.reqParam === 'Y' ? 'checked' : ''}>
                    </td>
                `;
                outputTbody.appendChild(tr);
            });
        }) 
        .catch(err => {
            console.error('입출력 항목 로딩 실패:', err);
            alert("입력/출력 항목 로딩에 실패했습니다.");
        });
}

function fetchProjectDetails(projectId) {
    fetch(`/projectStart/projectDetails?projectId=${projectId}`)
       .then(res => res.json())
       .then(data => {
         if (data) {
           populateApiTable(data.apiList || []);
           populateInputTable(data.inputList || []);
           populateOutputTable(data.outputList || []);
         }
       })
       .catch(err => {
         console.error('프로젝트 세부정보 로딩 오류:', err);
         Swal.fire('오류', '데이터를 불러오는 중 오류가 발생했습니다.', 'error');
       });
   }
function populateApiTable(apiList) {
     const tbody = document.querySelector("#apiTableBody"); // tbody에 id 부여 필요
     tbody.innerHTML = "";

     apiList.forEach((api, index) => {
       const row = `
         <tr>
           <td style="text-align:center;">${index + 1}</td>
           <td style="text-align:center;">${api.sourceName}</td>
           <td style="text-align:center;">${api.baseUrl}</td>
           <td style="text-align:center;">${api.responseFormat}</td>
         </tr>
       `;
       tbody.insertAdjacentHTML("beforeend", row);
     });
   }

function populateInputTable(inputList) {
  const tbody = document.querySelector("#inputTableBody");
  tbody.innerHTML = "";

  inputList.forEach(input => {
    const row = `
      <tr>
        <td style="text-align:center;">${input.defaultValue}</td>
        <td style="text-align:center;">${input.description}</td>
        <td style="text-align:center;">${input.type}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

function populateOutputTable(outputList) {
  const tbody = document.querySelector("#outputTableBody");
  tbody.innerHTML = "";

  outputList.forEach(output => {
    const row = `
      <tr>
        <td style="text-align:center;">${output.defaultValue}</td>
        <td style="text-align:center;">${output.description}</td>
        <td style="text-align:center;">${output.type}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}
window.addEventListener('DOMContentLoaded', () => {
    const path = window.location.pathname;

    const configBtn = document.getElementById("btn-config");
    const startBtn = document.getElementById("btn-start");

    if (configBtn && startBtn) {
       if (path.includes("projectConfig")) {
         configBtn.className = "btn-run";
         startBtn.className = "btn-config";
       } else if (path.includes("projectStart")) {
         configBtn.className = "btn-config";
         startBtn.className = "btn-run";
       } else {
         configBtn.className = "btn-config";
         startBtn.className = "btn-config";
       }
    }
  });
  
//수정 라인   
function toggleEdit(button) {
    const inputTbody = document.getElementById("inputTableBody");
    if (!inputTbody) {
        console.error("inputTableBody를 찾을 수 없습니다.");
        return;
    }

    if (button.textContent === "수정") {
        button.textContent = "확인";
        button.classList.remove("btn-outline-warning");
        button.classList.add("btn-outline-success");

        // td -> input
        inputTbody.querySelectorAll("tr").forEach(tr => {
            const td = tr.children[1]; // 기본값 td
            const value = td.textContent.trim();
            td.innerHTML = `<input type="text" style="width:100%;" value="${value}">`;
        });

    } else {
        button.textContent = "수정";
        button.classList.remove("btn-outline-success");
        button.classList.add("btn-outline-warning");

        // ✅ 1. 서버로 보낼 배열 선언
        const updatedInputs = [];

        // ✅ 2. input 값을 수집하고 화면에 반영
        inputTbody.querySelectorAll("tr").forEach(tr => {
            const td = tr.children[1];
            const input = td.querySelector("input");
            if (input) {
                td.textContent = input.value; // 화면에 반영
                updatedInputs.push({
                    inputId: tr.getAttribute("data-inputid"),
                    inputValue: input.value
                });
            }
        });

        // ✅ 3. 서버로 전송
        fetch('/projectStart/updateInputValues', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedInputs)
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '변경되었습니다',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    // 🔹 현재 선택된 row 다시 로드해서 최신 데이터 반영
                    const selectedRow = document.querySelector("#sourceTableBody tr.highlight");
                    if (selectedRow) {
                        setSelectedSourceId(selectedRow);
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'DB 업데이트 실패',
                    text: '잠시 후 다시 시도해주세요.'
                });
            }
        })
        .catch(err => {
            console.error("서버 통신 실패:", err);
            Swal.fire({
                icon: 'error',
                title: '서버 통신 실패',
                text: '잠시 후 다시 시도해주세요.'
            });
        });
    }
}
</script>
</body>
</html>