<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      th:with="activePage='config'">

<body>
<div layout:fragment="content">
	<div class="config-wrapper" style="position: relative;">
    <div class="bookmark" onclick="location.href='/projectConfig'">설정</div>
		<div class="bookmark2" style="margin-top: 52px;" onclick="location.href='/projectStart'">실행</div>
        <!-- 설정하기 화면 -->
        <div id="config" class="section-wrapper config-section">
        
<table style="width:100%;margin:0;padding:0;" border="0">
           <tbody>
               <tr>
                   <td class="tdContent">         
                       <div id="divProjectPro">
                           <h3 class="h3-project" style="font-size:24px;">프로젝트</h3>                                
                           <div>
                               <span class="inputLabel">프로젝트ID</span>
                               <input id="projectId" type="text" class="text" style="width:100px;margin-left:10px;text-align:center;" disabled>
                               <input id="projectName" type="text" class="text" style="width:179px;margin-left:5px;" disabled>
                               <button type="button" class="btn btn-secondary" onclick="openPopup2()" style="width: 3%;">...</button>          
                           </div>
                       </div>
                   </td>
               </tr>
           </tbody>
</table>
<!-- API 리스트 -->
        <div style="margin-top: 20px;">
            <h3 class="h3-project" style="font-size:24px;">API 목록</h3>
            <table>
                <thead>
                    <tr>
                    	<th style="width:86px;">No.</th>
					     <th style="text-align:center;">API 이름</th>
					     <th style="text-align:center;">요청 URL</th>
					     <th style="text-align:center;">응답 형식</th>
                    </tr>
                </thead>
                <tbody id="apiTableBody">
				     <tr th:each="source : ${sourceList}" 
		              th:attr="data-sourceid=${source.sourceId}"
		              onclick="setSelectedSourceId(this)">    
		              <td th:text="'S'+${source.sourceId}"></td>
		              <td th:text="${source.sourceName}"></td>
		              <td th:text="${source.baseUrl}"></td>
		              <td style="text-align: center;">JSON</td>
                </tbody>
            </table>
		</div>

<!-- 입력/출력 항목을 좌우로 배치하는 래퍼 -->
<div class="io-wrapper" style="display: flex; gap: 20px; margin-top: 30px;">
<!-- 입력 항목 -->
<div style="flex: 1;">
    <h3 class="h3-project" style="font-size:24px;">입력 항목</h3>
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="text-align:center;">항목키</th>
                <th style="text-align:center;">기본값</th>
                <th style="text-align:center;">설명</th>
                <th style="text-align:center;">항목구분 </th>
            </tr>
        </thead>
         <tbody id="inputTableBody">
            <tr th:each="input : ${inputList}" 
                th:attr="data-inputid=${input.inputId}" 
                onclick="setSelectedInputId(this)">
                <td th:text="${input.inputKey}"></td>
                <td th:text="${input.inputValue}"></td>
                <td th:text="${input.inputExplain}"></td>
                <td th:text="${input.reqParam}"></td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 출력 항목 -->
<div style="flex: 1;">
    <h3 class="h3-project" style="font-size:24px;">출력 항목</h3>
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
            	<th style="text-align:center;">항목키</th>
                <th style="text-align:center;">기본값</th>
                <th style="text-align:center;">설명</th>
                <th style="text-align:center;">항목구분</th>
            </tr>
        </thead>
        <tbody id="outputTableBody">
           <!-- 입력 항목도 같이 보이게 함 -->
          <tr th:each="input : ${inputList}" 
              th:attr="data-inputid=${input.inputId}" 
              onclick="setSelectedInputId(this)">
              <td th:text="${input.inputKey}"></td>
              <td th:text="${input.inputValue}"></td>
              <td th:text="${input.inputExplain}"></td>
              <td th:text="${input.reqParam}"></td>
          </tr>
          <!-- 출력 항목 표시 -->
          <tr th:each="output : ${outputList}" 
              th:attr="data-outputid=${output.outputId}" 
              onclick="setSelectedOutputId(this)">
              <td th:text="${output.outputKey}"></td>
              <td th:text="${output.outputValue}"></td>
              <td th:text="${output.outputExplain}"></td>
              <td th:text="${output.reqParam}"></td>
          </tr>
        </tbody>
    </table>
</div>
</div>	
<button type="button" onclick="openPopup5()" class="btn btn-outline-primary" style="font-size: 15px;margin-left: 1093px;margin-top: 24px;">실행 </button>
</div>
</div>
<!-- popup2 (...실행시 프로젝트 리스트 나오는 설정칸 ) -->
<div id="popup2">
  <div class="popup2-header">
    프로젝트 선택
    <span class="popup2-close" onclick="closePopup2()">×</span>
  </div>

  <div class="popup2-body">
    <table id="projectTable" class="project-table">
      <thead>
        <tr>
          <th>프로젝트ID</th>
          <th>프로젝트명</th>
        </tr>
      </thead>
      <tbody>
         <tr th:each="project : ${projectList}">
         <td th:text="'P'+${project.projectId}"></td>
         <td th:text="${project.projectName}"></td>
      </tr>
      </tbody>
    </table>
    <div class="popup2-buttons">
      <button type="button" class="btn btn-secondary" onclick="confirmSelection()">확인</button>
      <button type="button" class="btn btn-outline-secondary" onclick="closePopup2()">닫기</button>
    </div>
  </div>
</div>


<!-- popup5 (실행칸) -->
<div id="popup5">
  <div class="popup2-header">
    URL 확인
    <span class="popup2-close" onclick="closePopup5()">×</span>
  </div>
	
  <div class="popup2-body">
                <!-- 텍스트 영역 -->
			      <div class="mb-3">
			      <textarea id="totalUrl" rows="4" style="width: 100%; resize: vertical;"></textarea>
			    </div>

                <!-- 버튼 영역 -->
                <div class="buttons">
                    <button class="btn btn-success" style="margin-top: -27px; margin-left:431px">Excel 다운로드</button>
                </div>
            </div>
  </div>
</div>
<!-- pageScript 프래그먼트로 스크립트 채우기 -->
<th:block layout:fragment="pageScript">
<script>
window.addEventListener('DOMContentLoaded', () => {
    const path = window.location.pathname;

    if (path.includes("projectConfig")) {
        document.querySelector(".bookmark").classList.add("active");
    } else if (path.includes("projectStart")) {
        document.querySelector(".bookmark2").classList.add("active");
    }
});
function testConnection(button) {
    // 여기에 실제 연결 테스트 로직 또는 API 호출을 넣을 수도 있음
    const success = Math.random() > 0.5; // 임시로 성공/실패 무작위 처리

    if (success) {
        alert("연결되었습니다.");
    } else {
        alert("연결에 실패하였습니다.");
    }
}
function openPopup2() {
    document.getElementById("popup2").style.display = "block";
  }

//테이블 행 클릭 시
let selectedProject = null;

document.addEventListener("DOMContentLoaded", function () {
	  const projectTable = document.getElementById("projectTable");
	  const rows = projectTable.querySelectorAll("tbody tr");

	  rows.forEach(row => {
	    row.addEventListener("click", function () {
	      // 기존 선택 제거
	      rows.forEach(r => r.classList.remove("highlight"));

	      // 현재 선택한 행에 하이라이트
	      this.classList.add("highlight");

	      // ✅ 여기 수정함
	      const cells = this.getElementsByTagName("td");
	      selectedProject = {
	        projectId: parseInt(cells[0].innerText.trim().replace(/^P/, ''), 10),
	        projectName: cells[1].innerText.trim()
	      };
	    });
	  });
	});
//팝업 닫기
function closePopup2() {
  document.getElementById("popup2").style.display = "none";
  selectedProject = null;

  // 강조 해제
  document.querySelectorAll(".project-table tbody tr").forEach(row => {
    row.classList.remove("highlight");
  });
}
function openPopup5() {
    document.getElementById("popup5").style.display = "block";
  }
function closePopup5() {
    document.getElementById("popup5").style.display = "none";
   }
//선택 버튼 클릭 시
function confirmSelection() {
  if (selectedProject) {
    Swal.fire({
      title: '프로젝트 선택 완료',
      text: '프로젝트가 설정되었습니다.',
      icon: 'success',
      confirmButtonText: '확인'
    }).then(() => {
      document.getElementById("projectId").value = selectedProject.projectId;
      document.getElementById("projectName").value = selectedProject.projectName;

      // ✅ 연동된 데이터 불러오기
      fetchProjectDetails(selectedProject.projectId);

      closePopup2(); // 팝업 닫기
    });
  } else {
    Swal.fire({
      title: '선택된 항목 없음',
      text: '먼저 프로젝트를 선택해주세요.',
      icon: 'warning',
      confirmButtonText: '확인'
    });
  }
}

function fetchProjectDetails(projectId) {
	 fetch(`/projectStart/projectDetails?projectId=${projectId}`)
	    .then(res => res.json())
	    .then(data => {
	      if (data) {
	        populateApiTable(data.apiList || []);
	        populateInputTable(data.inputList || []);
	        populateOutputTable(data.outputList || []);
	      }
	    })
	    .catch(err => {
	      console.error('프로젝트 세부정보 로딩 오류:', err);
	      Swal.fire('오류', '데이터를 불러오는 중 오류가 발생했습니다.', 'error');
	    });
	}
function populateApiTable(apiList) {
	  const tbody = document.querySelector("#apiTableBody"); // tbody에 id 부여 필요
	  tbody.innerHTML = "";

	  apiList.forEach((api, index) => {
	    const row = `
	      <tr>
	        <td style="text-align:center;">${index + 1}</td>
	        <td style="text-align:center;">${api.sourceName}</td>
	        <td style="text-align:center;">${api.baseUrl}</td>
	        <td style="text-align:center;">${api.responseFormat}</td>
	      </tr>
	    `;
	    tbody.insertAdjacentHTML("beforeend", row);
	  });
	}

function populateInputTable(inputList) {
  const tbody = document.querySelector("#inputTableBody");
  tbody.innerHTML = "";

  inputList.forEach(input => {
    const row = `
      <tr>
        <td style="text-align:center;">${input.defaultValue}</td>
        <td style="text-align:center;">${input.description}</td>
        <td style="text-align:center;">${input.type}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

function populateOutputTable(outputList) {
  const tbody = document.querySelector("#outputTableBody");
  tbody.innerHTML = "";

  outputList.forEach(output => {
    const row = `
      <tr>
        <td style="text-align:center;">${output.defaultValue}</td>
        <td style="text-align:center;">${output.description}</td>
        <td style="text-align:center;">${output.type}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}
</script>
</body>
</html>