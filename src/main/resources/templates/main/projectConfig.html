<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      th:with="activePage='config'">

<body>
<div layout:fragment="content">
   <div class="config-wrapper" style="position: relative;">
       <div class="bookmark" onclick="location.href='/projectConfig'">설정</div>
      <div class="bookmark2" style="margin-top: 52px;" onclick="location.href='/projectStart'">실행</div>
        <!-- 설정하기 화면 -->
        <div id="config" class="section-wrapper config-section">
        
     <table style="width:100%;margin:0;padding:0;" border="0">
                <tbody>
                    <tr>
                        <td class="tdContent">         
                            <div id="divProjectPro">
                                <h3 class="h3-project" style="font-size:24px;">프로젝트</h3>                                
                                <div>
                                    <span class="inputLabel">프로젝트ID</span>
                                    <input id="projectId" type="text" class="text" style="width:100px;margin-left:10px;text-align:center;" th:value="${param.projectId}" disabled>
                                    <!-- 서버로 전송될 숨겨진 필드 -->
                                    <input type="hidden" id="projectIdHidden" name="projectId" th:value="${param.projectId}">
                                    <input id="projectName" type="text" class="text" style="width:179px;margin-left:5px;" th:value="${param.projectName}" disabled>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
      <!-- API 리스트 -->
            <div style="margin-top: 20px;">
                <h3 class="h3-project" style="font-size:24px;">API 목록</h3>
                <table>
                    <thead>
                        <tr>
                             <th style="width:86px;">No.</th>
						     <th style="text-align:center;">API 이름</th>
						     <th style="text-align:center;">요청 URL</th>
						     <th style="text-align:center;">응답 형식</th>
						     <th style="text-align:center;">테스트</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="source : ${sourceList}">
                         	<td th:text="'S'+${source.sourceId}"></td>
		                	<td th:text="${source.sourceName}"></td>
		                	<td th:text="${source.baseUrl}"></td>
		                	<td style="text-align: center;">JSON</td> 
		                	<td style="text-align: center;"><button type="button" onclick="testConnection(this)" class="btn btn-outline-primary" style="font-size: 13px;">테스트 연결</button>
		                	</td>
                        </tr>
                    </tbody>
                </table>
            		 <div style="margin-top: 15px;">
						  <button type="button" class="btn btn-outline-primary" onclick="openPopup3()">추가</button>
						  <button type="button" class="btn btn-outline-warning" onclick="deleteSource()">삭제</button>
					</div>
				</div>
            <!-- 입력/출력 항목을 좌우로 배치하는 래퍼 -->
            <div class="io-wrapper" style="display: flex; gap: 20px; margin-top: 30px;">
          
                <!-- 입력 항목 -->
                <div style="flex: 1;">
                    <h3 class="h3-project" style="font-size:24px;">입력 항목</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align:center;">입력 ID</th>
                                <th style="text-align:center;">입력명</th>
                                <th style="text-align:center;">입력항목 키</th>
                                <th style="text-align:center;">입력값</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td></td><td></td><td></td><td></td></tr>
                            <tr><td></td><td></td><td></td><td></td></tr>
                            <tr><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                    <div class="buttons">
                         <button type="button" class="btn btn-outline-primary" onclick="openPopup4()">추가</button>
                         <button type="button" class="btn btn-outline-warning" onclick="closePopup4()">삭제</button>
                    </div>
                </div>

                <!-- 출력 항목 -->
                <div style="flex: 1;">
                    <h3 class="h3-project" style="font-size:24px;">출력 항목</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align:center;">출력 ID</th>
                                <th style="text-align:center;">출력명</th>
                                <th style="text-align:center;">출력항목 키</th>
                                <th style="text-align:center;">출력값</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td></td><td></td><td></td><td></td></tr>
                            <tr><td></td><td></td><td></td><td></td></tr>
                            <tr><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
    	</div>
<!-- 팝업3 -->
	<div id="popup3">
	    <div class="popup-header">
	        소스 속성정보
	        <span class="popup-close" onclick="closePopup()"></span>
	    </div>
	    <div class="popup-body">
	        <table class="popup-table">
				<tr>
				  <td class="label required">API 이름<span class="asterisk">(*)</span></td>
				  <td><input type="text" id="sourceName" /></td>
				</tr>
				<tr>
				  <td class="label">요청URL</td>
				  <td><input type="text" id="baseUrl" /></td>
				</tr>
				 <tr>
					  <td class="label">응답형식</td>
					  <td>
					    <select id="projectExplain" name="responseFormat">
					      <option value="" disabled selected>--선택해주세요--</option>
					      <option value="json">JSON</option>
					      <option value="xml">XML</option>
					    </select>
					  </td>
					</tr>
	        </table>
	        <div class="popup-buttons">
            <button type="button" class="btn btn-outline-success" onclick="saveSource()">저장</button>
            <button type="button" class="btn btn-outline-warning" onclick="closePopup3()">취소</button>
	        </div>
	    </div>
	</div>

<!-- 팝업4 -->	
<div id="popup4">
    <div class="popup-header">입력 속성정보
        <span class="popup-close" onclick="closePopup()"></span>
    </div>
    <div class="popup-body">
        <table class="popup-table">
			<tr>
			   <td class="label required">입력명<span class="asterisk">(*)</span></td>
  			   <td><input type="text" id="inputName" placeholder="Ex) 제목" /></td>
			</tr>
			<tr>
			  <td class="label required">입력항목키<span class="asterisk">(*)</span></td>
			  <td>
			    <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
			      <input type="text" id="inputKey" placeholder="Ex) obj1" style="flex: 1;" />
			      <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; white-space: nowrap;">
			        <span>필수 여부</span>
			        <input type="checkbox" id="isRequired" style="width: 16px; height: 16px;" />
			      </label>
			    </div>
			  </td>
			</tr>
			<tr>
			  <td class="label">입력값</td>
			  <td>
			    <input type="text" id="inputValue" placeholder="Ex) 대전" style="width: 100%;" />
			
			    <!-- select box 추가 -->
			    <select id="valueType" style="margin-top: 6px; width: 100%; padding: 4px 6px;">
			      <option value="">입력값 유형 선택</option>
			      <option value="string">문자형</option>
			      <option value="number">숫자형</option>
			    </select>
			  </td>
			</tr>
        </table>
        <div class="popup-buttons">
            <button type="button" class="btn btn-outline-success">저장</button>
            <button type="button" class="btn btn-outline-warning" onclick="closePopup4()" style="margin-right:-50px">취소</button>
        </div>
    </div>
</div>
</div>
</div>
<!-- pageScript 프래그먼트로 스크립트 채우기 -->
<th:block layout:fragment="pageScript">
<script>
function openSourcePopup() {
	document.getElementById("sourcePopup").style.display = "block";
}

function closeSourcePopup() {
    document.getElementById("sourcePopup").style.display = "none";
}
function openPopup3() {
    document.getElementById("popup3").style.display = "block";
  }
function closePopup3() {
    document.getElementById("popup3").style.display = "none";
   }
function openPopup4() {
    document.getElementById("popup4").style.display = "block";
  }
function closePopup4() {
    document.getElementById("popup4").style.display = "none";
   }
function saveSource() {
	const name = document.querySelector("#sourceName").value.trim();
	const baseUrl = document.querySelector("#baseUrl").value.trim();
	const rawProjectId = document.querySelector("#projectIdHidden").value.trim();	// 문자 + 숫자 P1
	const projectIdNumber = rawProjectId.replace(/[^0-9]/g, ''); // 숫자만 추출
	
	console.log("source 입력값:", name);
	console.log("baseUrl 입력값:", baseUrl);
	console.log("projectId 입력값:", projectId);
	
	if(name === "") {
		Swal.fire({
			title : "입력 오류",
			text : "API 명을 입력해주세요.",
			icon : "warning"
		});
		return;
	}
	const data = {
			sourceName : name,
			baseUrl : baseUrl,
			projectId: Number(projectIdNumber)  // 숫자로 보냄
	};
	
	fetch("/projectConfig", {
		method : "POST",
		headers : {
			"Content-type": "application/json"
		},
		body : JSON.stringify(data)
	})
	.then(response => {
		if (!response.ok) {
			throw new Error("서버 응답 오류");
		}
		return response.text();
	})
	.then(result => {
		if(result === "success") {
			Swal.fire({
				title : '등록 성공',
				text : '저장 완료되었습니다',
				icon: 'success', 
                confirmButtonText: '확인'
            }).then(() => {
            	closePopup3();
                location.reload();					
			});
		} else {
			Swal.fire({
				title: '등록 실패',
                text: '필수 항목을 입력해주세요.',
                icon: 'warning'
			});
		}
	})
    .catch(error => {
        console.error("에러발생:", error);
        Swal.fire({
            title: '등록 실패',
            text: '저장 중 오류가 발생했습니다.',
            icon: 'error'
        });
    });	
}
function testConnection(button) {
    // 여기에 실제 연결 테스트 로직 또는 API 호출을 넣을 수도 있음
    const success = Math.random() > 0.5; // 임시로 성공/실패 무작위 처리

    if (success) {
        alert("연결되었습니다.");
    } else {
        alert("연결에 실패하였습니다.");
    }
}
</script>
</body>
</html>
